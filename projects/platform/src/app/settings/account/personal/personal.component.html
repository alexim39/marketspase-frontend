<mat-card class="profile-card">
  <mat-card-header>
    <mat-card-title class="profile-title">
      <mat-icon class="profile-icon">person_outline</mat-icon>
      Profile Settings
    </mat-card-title>
    <mat-card-subtitle class="profile-subtitle">
      Manage your personal information and account settings
    </mat-card-subtitle>
  </mat-card-header>

  <mat-divider></mat-divider>

  <mat-card-content>
    <form [formGroup]="profileForm" class="profile-form">

      <!-- Basic Information Section -->
      <div class="form-section">
        <h3 class="section-header">
          <mat-icon>info</mat-icon>
          Basic Information
        </h3>
        
        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Display Name</mat-label>
            <input matInput formControlName="displayName">
            <mat-icon matSuffix>person</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Gender</mat-label>
            <mat-select formControlName="gender" required>
              @for (gender of genders; track gender) {
                <mat-option [value]="gender">
                  {{ gender }}
                </mat-option>
              }
            </mat-select>
            <mat-icon matSuffix>person</mat-icon>
            @if (profileForm.get('gender')?.hasError('required')) {
              <mat-error>
                Gender is required
              </mat-error>
            }
          </mat-form-field>
          
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Email</mat-label>
            <input matInput type="email" formControlName="email">
            <mat-icon matSuffix>email</mat-icon>
            @if (profileForm.get('email')?.hasError('email')) {
              <mat-error>
                Please enter a valid email
              </mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Phone Number</mat-label>
            <input matInput formControlName="phone" required>
            <mat-icon matSuffix>phone</mat-icon>
            <mat-hint>Your WhatsApp number</mat-hint>
            @if (profileForm.get('phone')?.hasError('required')) {
              <mat-error>
                Phone is required
              </mat-error>
            }
            <!-- <mat-error *ngIf="profileForm.get('phone')?.hasError('pattern')">Please enter a valid phone number</mat-error> -->
          </mat-form-field>
        </div>
      </div>

      <!-- Additional Information Section -->
      <div class="form-section">
        <h3 class="section-header">
          <mat-icon>description</mat-icon>
          Additional Information
        </h3>

        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Date of Birth</mat-label>
            <input matInput [matDatepicker]="dobPicker" formControlName="dob" [max]="maxDate">
            <mat-datepicker-toggle matSuffix [for]="dobPicker"></mat-datepicker-toggle>
            <mat-datepicker #dobPicker></mat-datepicker>
            <mat-hint>MM/DD/YYYY</mat-hint>
          </mat-form-field>
        </div>

        <!-- Address fields with Autocomplete setup -->
        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Street Address (Start Typing for Autocomplete)</mat-label>
            <!-- Add the template reference variable #streetInput here -->
            <input matInput formControlName="street" required #streetInput>
            <mat-icon matSuffix>location_on</mat-icon>
            @if (profileForm.get('street')?.hasError('required')) {
               <mat-error>
                Street address is required
              </mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>City</mat-label>
            <input matInput formControlName="city" required>
            <mat-icon matSuffix>location_city</mat-icon>
            @if (profileForm.get('city')?.hasError('required')) {
              <mat-error>
                City is required
              </mat-error>  
            }
            
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
          <mat-label>Country</mat-label>
          <input 
            type="text" 
            matInput 
            formControlName="country" 
            [matAutocomplete]="auto"
            required
          >
          <mat-autocomplete #auto="matAutocomplete">
            @for (country of filteredCountries(); track country) {
              <mat-option [value]="country">
                {{ country }}
              </mat-option>
            }            
          </mat-autocomplete>
          @if (profileForm.get('country')?.hasError('required')) {
            <mat-error>
              Country is required
            </mat-error>
          }
        </mat-form-field>

        @if (showStateSelect()) {
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>State</mat-label>
            <mat-select formControlName="state" required>
              @for (state of nigerianStates; track state) {
                <mat-option [value]="state">
                  {{ state }}
                </mat-option>
              }              
            </mat-select>
            <mat-icon matSuffix>location_city</mat-icon>
            @if (profileForm.get('state')?.hasError('required')) {
              <mat-error>
                State is required
              </mat-error>
            }            
          </mat-form-field>
        }
          
        @if (showStateAutocomplete()) {
          <!-- This is now primarily for displaying the state/province value populated by Autocomplete or manual entry -->
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>State/Province</mat-label>
            <input matInput formControlName="state">
            <mat-icon matSuffix>location_city</mat-icon>
            <!-- Only show error if explicitly required/invalid, but usually Autocomplete handles it -->
            @if (profileForm.get('state')?.hasError('required')) {
              <mat-error>
                State is required
              </mat-error>
            }
          </mat-form-field>
        }
        </div>

        <mat-form-field appearance="outline" class="form-field full-width">
          <mat-label>Bio</mat-label>
          <textarea matInput formControlName="biography" rows="3" placeholder="Tell the MarketSpase community about yourself"></textarea>
          <mat-icon matSuffix>edit</mat-icon>
          <mat-hint>Max 500 characters</mat-hint>
          @if (profileForm.get('bio')?.hasError('maxlength')) {
            <mat-error>
            Bio cannot exceed 500 characters
          </mat-error>
          }          
        </mat-form-field>
      </div>

      <!-- Account Status Section -->
      <div class="form-section">
        <h3 class="section-header">
          <mat-icon>security</mat-icon>
          Account Status
        </h3>

        <div class="account-status">
          <mat-slide-toggle 
            color="primary"
            [checked]="user()?.isActive" 
            [disabled]="user()?.isActive || isLoading()"
            (change)="onAccountStatusChange($event)">
            {{ user()?.isActive ? 'Account Active' : 'Activate Account' }}
          </mat-slide-toggle>
          <span class="status-message">
            Your account is currently {{ user()?.isActive ? 'active' : 'inactive' }}
          </span>
        </div>
      </div>
    </form>
  </mat-card-content>

  <mat-divider/>

  <mat-card-actions class="form-actions">
    <button 
      mat-flat-button 
      color="primary" 
      class="save-button"
      [disabled]="profileForm.invalid || isLoading()"
      (click)="onSubmit()">
      @if (isLoading()) {
        <mat-spinner diameter="20"/>
      } @else {
        Save Changes
      }      
    </button>
  </mat-card-actions>
</mat-card>
