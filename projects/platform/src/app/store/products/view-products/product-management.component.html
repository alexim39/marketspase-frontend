<!-- product-management.component.html -->
<div class="product-management">
  <!-- Header Section -->
  <div class="management-header">
    <div class="header-content">
      <div class="header-left">
        <h2>Product Management</h2>
        <p>Manage all products for {{ store().name }}</p>
      </div>
      
      <div class="product-stats">
        <div class="stat-item">
          <span class="stat-value">{{ products().length }}</span>
          <span class="stat-label">Total Products</span>
        </div>
        <div class="stat-item">
          <span class="stat-value warn">{{ lowStockProducts().length }}</span>
          <span class="stat-label">Low Stock</span>
        </div>
        <div class="stat-item">
          <span class="stat-value error">{{ outOfStockProducts().length }}</span>
          <span class="stat-label">Out of Stock</span>
        </div>
        <div class="stat-item">
          <span class="stat-value">{{ filteredProducts().length }}</span>
          <span class="stat-label">Filtered</span>
        </div>
      </div>
    </div>
    
    <!-- Controls Bar -->
    <div class="controls-bar">
      <div class="controls-left">
        <!-- Search Box -->
        <div class="search-box">
          <mat-icon>search</mat-icon>
          <input 
            type="text" 
            placeholder="Search products..." 
            [value]="searchQuery()"
            (input)="onSearch($event)"
          >
        </div>
        
        <!-- Category Filter -->
        <mat-form-field class="category-filter" appearance="outline">
          <mat-label>Category</mat-label>
          <mat-select [value]="selectedCategory()" (selectionChange)="onCategoryChange($event.value)">
            <mat-option value="all">All Categories</mat-option>
            @for (category of categories(); track category) {
              <mat-option [value]="category">{{ category }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
        
        <!-- View Controls -->
        <div class="view-controls">
          <button 
            mat-icon-button 
            [class.active]="viewMode() === 'grid'"
            (click)="setGridView()"
            matTooltip="Grid View"
          >
            <mat-icon>grid_view</mat-icon>
          </button>
          <button 
            mat-icon-button 
            [class.active]="viewMode() === 'list'"
            (click)="setListView()"
            matTooltip="List View"
          >
            <mat-icon>list</mat-icon>
          </button>
        </div>
      </div>
      
      <div class="controls-right">
        <!-- Quick Actions -->
        <button 
          mat-stroked-button 
          (click)="manageInventory()"
          matTooltip="Manage Inventory"
        >
          <mat-icon>inventory</mat-icon>
          <span class="button-text">Inventory</span>
        </button>
        
        <button 
          mat-stroked-button 
          (click)="exportProducts()"
          matTooltip="Export Products"
        >
          <mat-icon>download</mat-icon>
          <span class="button-text">Export</span>
        </button>
        
        <!-- Add Product Button -->
        <button 
          mat-raised-button 
          color="primary" 
          (click)="addProduct()"
          matTooltip="Add New Product"
        >
          <mat-icon>add</mat-icon>
          <span class="button-text">Add Product</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Main Content -->
  <div class="product-content">
    @if (loading()) {
      <div class="loading-overlay">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Loading products...</p>
      </div>
    }
    
    @if (filteredProducts().length === 0 && !loading()) {
      <div class="empty-state">
        <mat-icon class="empty-icon">inventory_2</mat-icon>
        <h3>No Products Found</h3>
        <p>
          @if (searchQuery() || selectedCategory() !== 'all') {
            No products match your search criteria. Try adjusting your filters.
          } @else {
            This store has no products yet. Start by adding your first product!
          }
        </p>
        <button 
          mat-raised-button 
          color="primary" 
          (click)="addProduct()"
        >
          <mat-icon>add</mat-icon>
          Add Product
        </button>
      </div>
    } @else {
      <!-- Grid View -->
      @if (viewMode() === 'grid') {
        <div class="products-grid">
          @for (product of paginatedProducts(); track trackByProductId($index, product)) {
            <div class="product-card">
              <!-- Product Image -->
              <div class="product-image">
                @if (product.images) {
                  <img [src]="product.images[0]?.url" [alt]="product.name" (error)="handleImageError($event)">
                } @else {
                  <div class="no-image">
                    <mat-icon>image</mat-icon>
                    <span>No Image</span>
                  </div>
                }
                
                <!-- Product Badges -->
                <div class="product-badges">
                  @if (!product.isActive) {
                    <span class="badge inactive">Inactive</span>
                  }
                  @if (product.isFeatured) {
                    <span class="badge featured">Featured</span>
                  }
                  @if (product.hasVariants) {
                    <span class="badge variants">Variants</span>
                  }
                  <span 
                    class="badge stock" 
                    [class]="getStockStatus(product).color"
                  >
                    {{ getStockStatus(product).text }}
                  </span>
                </div>
              </div>
              
              <!-- Product Content -->
              <div class="product-content">
                <h3 class="product-name" [matTooltip]="product.name">
                  {{ product.name | truncate:30 }}
                </h3>
                
                @if (product.description) {
                  <p class="product-description">
                    {{ product.description | truncate:80 }}
                  </p>
                }
                
                <div class="product-meta">
                  <span class="product-category">
                    {{ product.category || 'Uncategorized' }}
                  </span>
                  <span class="product-price">
                    ${{ product.price | number:'1.2-2' }}
                    @if (product.originalPrice && product.originalPrice > product.price) {
                      <span class="original-price">
                        ${{ product.originalPrice | number:'1.2-2' }}
                      </span>
                    }
                  </span>
                </div>
                
                <div class="product-stats">
                  <span class="stat" matTooltip="Quantity in stock">
                    <mat-icon>inventory_2</mat-icon>
                    <span>{{ product.quantity }}</span>
                  </span>
                  <span class="stat" matTooltip="Views">
                    <mat-icon>visibility</mat-icon>
                    <span>{{ product.viewCount || 0 }}</span>
                  </span>
                  <span class="stat" matTooltip="Sales">
                    <mat-icon>shopping_cart</mat-icon>
                    <span>{{ product.purchaseCount || 0 }}</span>
                  </span>
                </div>
              </div>
              
              <!-- Product Actions -->
              <div class="product-actions">
                <div class="quick-actions">
                  <button 
                    mat-icon-button 
                    color="primary"
                    (click)="viewProduct(product)"
                    matTooltip="View Details"
                  >
                    <mat-icon>visibility</mat-icon>
                  </button>
                  <button 
                    mat-icon-button 
                    color="accent"
                    (click)="editProduct(product)"
                    matTooltip="Edit Product"
                  >
                    <mat-icon>edit</mat-icon>
                  </button>
                </div>
                
                <button 
                  mat-icon-button 
                  [matMenuTriggerFor]="productMenu"
                  (click)="$event.stopPropagation()"
                  class="menu-btn"
                >
                  <mat-icon>more_vert</mat-icon>
                </button>
                
                <!-- Product Menu -->
                <mat-menu #productMenu="matMenu" xPosition="before">
                  <button mat-menu-item (click)="toggleProductStatus(product)">
                    <mat-icon>{{ product.isActive ? 'pause_circle' : 'play_circle' }}</mat-icon>
                    <span>{{ product.isActive ? 'Deactivate' : 'Activate' }}</span>
                  </button>
                  <button mat-menu-item (click)="duplicateProduct(product)">
                    <mat-icon>content_copy</mat-icon>
                    <span>Duplicate</span>
                  </button>
                  <mat-divider></mat-divider>
                  <button 
                    mat-menu-item 
                    (click)="deleteProduct(product)"
                    class="delete-action"
                  >
                    <mat-icon>delete</mat-icon>
                    <span>Delete</span>
                  </button>
                </mat-menu>
              </div>
            </div>
          }
        </div>
      } 
      
      <!-- List View -->
      @else {
        <div class="products-list">
          <table mat-table [dataSource]="paginatedProducts()" class="products-table">
            <!-- Product Column -->
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef>Product</th>
              <td mat-cell *matCellDef="let product">
                <div class="product-info">
                  @if (product.mainImage) {
                    <img [src]="product.mainImage" [alt]="product.name" class="product-thumb">
                  } @else {
                    <div class="no-thumb">
                      <mat-icon>image</mat-icon>
                    </div>
                  }
                  <div class="product-details">
                    <span class="product-name">{{ product.name }}</span>
                    @if (product.description) {
                      <span class="product-description">{{ product.description | truncate:50 }}</span>
                    }
                  </div>
                </div>
              </td>
            </ng-container>
            
            <!-- Category Column -->
            <ng-container matColumnDef="category">
              <th mat-header-cell *matHeaderCellDef>Category</th>
              <td mat-cell *matCellDef="let product">
                <span class="category-chip">{{ product.category || 'Uncategorized' }}</span>
              </td>
            </ng-container>
            
            <!-- Price Column -->
            <ng-container matColumnDef="price">
              <th mat-header-cell *matHeaderCellDef>Price</th>
              <td mat-cell *matCellDef="let product" class="price-cell">
                <div class="price-display">
                  <span class="current-price">${{ product.price | number:'1.2-2' }}</span>
                  @if (product.originalPrice && product.originalPrice > product.price) {
                    <span class="original-price">${{ product.originalPrice | number:'1.2-2' }}</span>
                  }
                </div>
              </td>
            </ng-container>
            
            <!-- Stock Column -->
            <ng-container matColumnDef="quantity">
              <th mat-header-cell *matHeaderCellDef>Stock</th>
              <td mat-cell *matCellDef="let product">
                <div 
                  class="stock-info" 
                  [class]="getStockStatus(product).color"
                  matTooltip="{{ product.quantity }} in stock"
                >
                  <mat-icon>{{ getStockStatus(product).icon }}</mat-icon>
                  <span>{{ getStockStatus(product).text }}</span>
                </div>
              </td>
            </ng-container>
            
            <!-- Status Column -->
            <ng-container matColumnDef="isActive">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let product">
                <mat-chip-option 
                  [color]="product.isActive ? 'primary' : 'warn'" 
                  [selected]="product.isActive"
                  (click)="toggleProductStatus(product)"
                >
                  {{ product.isActive ? 'Active' : 'Inactive' }}
                </mat-chip-option>
              </td>
            </ng-container>
            
            <!-- Performance Column -->
            <ng-container matColumnDef="promoterTracking">
              <th mat-header-cell *matHeaderCellDef>Performance</th>
              <td mat-cell *matCellDef="let product">
                <div class="performance-stats">
                  <div class="performance-item" matTooltip="Views">
                    <mat-icon>visibility</mat-icon>
                    <span>{{ product.viewCount || 0 }}</span>
                  </div>
                  <div class="performance-item" matTooltip="Sales">
                    <mat-icon>shopping_cart</mat-icon>
                    <span>{{ product.purchaseCount || 0 }}</span>
                  </div>
                  <div class="performance-item" matTooltip="Rating">
                    <mat-icon>star</mat-icon>
                    <span>{{ product.averageRating || 0 | number:'1.1-1' }}</span>
                  </div>
                </div>
              </td>
            </ng-container>
            
            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef class="actions-header">Actions</th>
              <td mat-cell *matCellDef="let product" class="actions-cell">
                <button 
                  mat-icon-button 
                  [matMenuTriggerFor]="actionMenu"
                  (click)="$event.stopPropagation()"
                  class="action-btn"
                >
                  <mat-icon>more_vert</mat-icon>
                </button>
                
                <mat-menu #actionMenu="matMenu" xPosition="before">
                  <button mat-menu-item (click)="viewProduct(product)">
                    <mat-icon>visibility</mat-icon>
                    <span>View Details</span>
                  </button>
                  <button mat-menu-item (click)="editProduct(product)">
                    <mat-icon>edit</mat-icon>
                    <span>Edit Product</span>
                  </button>
                  <button mat-menu-item (click)="toggleProductStatus(product)">
                    <mat-icon>{{ product.isActive ? 'pause_circle' : 'play_circle' }}</mat-icon>
                    <span>{{ product.isActive ? 'Deactivate' : 'Activate' }}</span>
                  </button>
                  <button mat-menu-item (click)="duplicateProduct(product)">
                    <mat-icon>content_copy</mat-icon>
                    <span>Duplicate</span>
                  </button>
                  <mat-divider></mat-divider>
                  <button 
                    mat-menu-item 
                    (click)="deleteProduct(product)"
                    class="delete-action"
                  >
                    <mat-icon>delete</mat-icon>
                    <span>Delete</span>
                  </button>
                </mat-menu>
              </td>
            </ng-container>
            
            <tr mat-header-row *matHeaderRowDef="displayedColumns()"></tr>
            <tr 
              mat-row 
              *matRowDef="let row; columns: displayedColumns();" 
              class="product-row"
              (click)="viewProduct(row)"
            ></tr>
          </table>
        </div>
      }
      
      <!-- Pagination -->
      @if (filteredProducts().length > 0) {
        <div class="pagination-container">
          <mat-paginator
            [length]="filteredProducts().length"
            [pageSize]="pageSize()"
            [pageSizeOptions]="[10, 25, 50, 100]"
            [pageIndex]="currentPage()"
            (page)="onPageChange($event)"
            showFirstLastButtons
          ></mat-paginator>
          
          <div class="pagination-info">
            Showing {{ (currentPage() * pageSize()) + 1 }} - 
            <!-- {{ (currentPage() + 1) * pageSize(), filteredProducts().length }}  -->
            of {{ filteredProducts().length }} products
          </div>
        </div>
      }
    }
  </div>
</div>