<!-- community-feed.component.html -->
<div class="community-feed-section">
  <!-- Section Header -->
  @if (showHeader()) {
    <div class="section-header">
      <div class="section-title-wrapper">
        <h2 class="section-title">Community Pulse</h2>
        <div class="live-indicator">
          <div class="pulse-dot"></div>
          <span>LIVE</span>
        </div>
      </div>
      <div class="section-actions">
        @if (userRole() === 'marketer') {
          <button mat-button color="primary" (click)="createPost.emit()" class="create-post-btn">
            <mat-icon>edit</mat-icon>
            Create Post
          </button>
        }
        <button mat-stroked-button color="accent" (click)="viewAll.emit()">
          View All
        </button>
      </div>
    </div>
  }

  <!-- Live Activity Toast -->
 <!--  @if (liveActivities().length > 0) {
    <div class="live-activity-toast">
      <div class="activity-content">
        <span class="activity-text">
          <strong>{{ liveActivities()[0].author }}</strong> {{ liveActivities()[0].message }}
        </span>
        <span class="activity-time">{{ liveActivities()[0].time }}</span>
      </div>
    </div>
  } -->
  
  <div class="feed-preview">
    <!-- Loading State -->
    @if (loading()) {
      <div class="loading-state">
        <mat-icon class="spin">autorenew</mat-icon>
        <span>Loading community updates...</span>
      </div>
    } @else {
      <!-- Feed Content -->
      @if (posts().length > 0) {
        <!-- Trending Topics Banner -->
        @if (trendingHashtags().length > 0) {
          <div class="trending-banner">
            <div class="trending-left">
              <mat-icon>trending_up</mat-icon>
              <span>Trending now:</span>
            </div>
            <div class="trending-tags">
              @for (tag of trendingHashtags().slice(0, 5); track tag.tag) {
                <button class="trending-tag" (click)="onHashtagClick($event, tag.tag)">
                  #{{ tag.tag }}
                  @if (tag.count > 0) {
                    <span class="tag-count">{{ tag.count }}</span>
                  }
                </button>
              }
            </div>
          </div>
        }

        <!-- Today's Activity Stats -->
        <div class="activity-stats">
          <!-- <div class="stat-card">
            <mat-icon class="stat-icon">people</mat-icon>
            <div class="stat-info">
              <span class="stat-value">{{ activityStats().activeUsers }}</span>
              <span class="stat-label">active now</span>
            </div>
          </div> -->
          <div class="stat-card">
            <mat-icon class="stat-icon">post_add</mat-icon>
            <div class="stat-info">
              <span class="stat-value">{{ activityStats().postsToday }}</span>
              <span class="stat-label">posts today</span>
            </div>
          </div>
          <div class="stat-card">
            <mat-icon class="stat-icon">whatshot</mat-icon>
            <div class="stat-info">
              <span class="stat-value">{{ activityStats().totalEngagement }}</span>
              <span class="stat-label">engagements</span>
            </div>
          </div>
        </div>
        
        <!-- Recent Posts Grid -->
        <div class="recent-posts-grid">
          <h3 class="grid-title">
            <mat-icon>update</mat-icon>
            Latest from the community
          </h3>
          
          <div class="posts-grid">
            @for (post of recentPosts(); track post._id) {
              <mat-card class="community-post-card" 
                        [class.new]="isNewPost(post)"
                        (click)="onPostClick(post._id)">
                
                <!-- New indicator -->
                @if (isNewPost(post)) {
                  <div class="new-post-badge">
                    <mat-icon>fiber_new</mat-icon>
                    <span>Just posted</span>
                  </div>
                }

                <mat-card-header class="post-header">
                  <div class="post-user-info">
                    <div class="user-avatar-wrapper">
                      <img 
                        [src]="post.author?.avatar || 'img/avatar.png'" 
                        [alt]="post.author?.displayName" 
                        class="post-avatar"
                      >
                      @if (post.author?.badge) {
                        <div class="badge-indicator" [class]="post.author?.badge" 
                             [matTooltip]="getBadgeTooltip(post.author?.badge ?? '')">
                        </div>
                      }
                    </div>
                    <div class="user-details">
                      <h3 class="user-name">{{ post.author?.displayName || 'Community Member' }}</h3>
                      <div class="user-meta">
                        <span class="user-role">{{ post.author?.role || 'Member' }}</span>
                        <span class="post-time">{{ feedService.formatTime(post.createdAt) }}</span>
                      </div>
                    </div>
                  </div>
                </mat-card-header>
                
                <mat-card-content class="post-content">
                  <p class="post-text">{{ post.content | slice:0:100 }}{{ post.content.length > 100 ? '...' : '' }}</p>

              <!-- Media Preview Section -->
              @if (post.media && post.media.length > 0) {
                <div class="post-media-preview" (click)="$event.stopPropagation()">
                  <!-- Check if this media is expanded -->
                  @if (expandedMedia()?.postId === post._id && expandedMedia()?.mediaIndex === 0) {
                    <!-- Expanded view for images -->
                    @if (post.media[0].type === 'image') {
                      <div class="expanded-media-container">
                        <img 
                          [src]="post.media[0].url" 
                          alt="Expanded image"
                          class="expanded-image"
                        >
                        <div class="expanded-media-controls">
                          <button class="media-nav-btn prev-btn" (click)="navigateMedia('prev', post, $event)">
                            <mat-icon>chevron_left</mat-icon>
                          </button>
                          <button class="media-nav-btn next-btn" (click)="navigateMedia('next', post, $event)">
                            <mat-icon>chevron_right</mat-icon>
                          </button>
                          <button class="close-media-btn" (click)="closeExpandedMedia($event)">
                            <mat-icon>close</mat-icon>
                          </button>
                        </div>
                        <div class="media-counter">
                          {{ expandedMedia()?.mediaIndex! + 1 }} / {{ post.media.length }}
                        </div>
                      </div>
                    }
                    
                    <!-- Expanded view for videos -->
                    @if (post.media[0].type === 'video' && isVideoPlaying(post._id)) {
                      <div class="expanded-media-container video-expanded">
                        <iframe 
                          [src]="getSafeVideoUrl(post.media[0].url)"
                          frameborder="0"
                          allow="autoplay; fullscreen; picture-in-picture"
                          allowfullscreen
                          class="video-iframe"
                        ></iframe>
                        <button class="close-media-btn" (click)="closeExpandedMedia($event)">
                          <mat-icon>close</mat-icon>
                        </button>
                      </div>
                    }
                  } @else {
                    <!-- Thumbnail view -->
                    @if (post.media[0].type === 'image') {
                      <div class="media-container" (click)="toggleImage(post._id, 0, $event)">
                        <img 
                          [src]="post.media[0].url" 
                          [alt]="'Post image'"
                          class="media-image"
                          loading="lazy"
                        >
                        @if (post.media.length > 1) {
                          <div class="media-count-badge">
                            <mat-icon>collections</mat-icon>
                            <span>+{{ post.media.length - 1 }}</span>
                          </div>
                        }
                      </div>
                    }
                    
                    @if (post.media[0].type === 'video') {
                      <div class="media-container video-container" 
                          [class.playing]="isVideoPlaying(post._id)"
                          (click)="playVideo(post._id, post.media[0], $event)">
                        
                        @if (!isVideoPlaying(post._id)) {
                          <!-- Thumbnail with play button -->
                          <img 
                            [src]="post.media[0].thumbnail || 'img/video-placeholder.jpg'" 
                            alt="Video thumbnail"
                            class="media-image"
                          >
                          <div class="video-play-overlay">
                            <mat-icon class="play-icon">play_circle</mat-icon>
                          </div>
                        } @else {
                          <!-- Inline video player -->
                          <div class="inline-video-player">
                            <video 
                              [src]="post.media[0].url" 
                              controls
                              autoplay
                              class="inline-video"
                              (click)="$event.stopPropagation()"
                            ></video>
                            <button class="close-video-btn" (click)="playVideo(post._id, post.media[0], $event)">
                              <mat-icon>close</mat-icon>
                            </button>
                          </div>
                        }
                      </div>
                    }
                    
                    @if (post.media[0].type === 'link') {
                      <div class="link-preview" (click)="openLink(post.media[0].url, $event)">
                        <mat-icon>link</mat-icon>
                        <span class="link-url">{{ post.media[0].url | slice:0:40 }}</span>
                        <mat-icon class="open-link">open_in_new</mat-icon>
                      </div>
                    }
                  }
                </div>
              }
                  
                  <!-- Post type specific preview -->
                  @if (post.type === 'earnings' && post.earnings) {
                    <div class="type-preview earnings-preview">
                      <mat-icon>emoji_events</mat-icon>
                      <span>Earned ₦{{ post.earnings.amount | number:'1.0-0' }}</span>
                      @if (post.earnings.milestone) {
                        <span class="milestone">• {{ post.earnings.milestone }}</span>
                      }
                    </div>
                  }
                  
                  @if (post.type === 'campaign' && post.campaign?.name) {
                    <div class="type-preview campaign-preview">
                      <mat-icon>campaign</mat-icon>
                      <span>{{ post.campaign?.name | slice:0:30 }}</span>
                      @if (post.campaign?.progress) {
                        <span class="progress">• {{ post.campaign?.progress }}% complete</span>
                      }
                    </div>
                  }
                  
                  <!-- Engagement preview -->
                  <div class="post-actions-mini">
                    <button class="action-item" (click)="onLike($event, post)">
                      <mat-icon [class.liked]="likedPosts().has(post._id)">favorite</mat-icon>
                      <span>{{ post.likeCount }}</span>
                    </button>
                    <button class="action-item" (click)="onSave($event, post._id)">
                      <mat-icon [class.saved]="savedPosts().has(post._id)">bookmark</mat-icon>
                      <span>Save</span>
                    </button>
                    <!-- <div class="action-item">
                      <mat-icon>chat</mat-icon>
                      <span>{{ post.commentCount }}</span>
                    </div> -->
                    <button class="action-item" (click)="onShare($event, post)">
                      <mat-icon>share</mat-icon>
                      <span>{{ post.shareCount }}</span>
                    </button>
                  </div>
                  
                  <!-- Hashtags -->
                  @if (post.hashtags && post.hashtags.length > 0) {
                    <div class="post-hashtags">
                      @for (tag of post.hashtags.slice(0, 3); track tag) {
                        <button class="hashtag" (click)="onHashtagClick($event, tag)">
                          #{{ tag }}
                        </button>
                      }
                      @if (post.hashtags.length > 3) {
                        <span class="more-hashtags">+{{ post.hashtags.length - 3 }}</span>
                      }
                    </div>
                  }
                </mat-card-content>
              </mat-card>
            }
          </div>
          
          <!-- View All Link -->
          @if (posts().length > limit()) {
            <div class="view-all-link">
              <button mat-stroked-button (click)="viewAll.emit()">
                <!-- View all {{ posts().length }} posts  -->
                View all posts 
                <mat-icon>arrow_forward</mat-icon>
              </button>
            </div>
          }
        </div>
        
      } @else {
        <!-- Empty State -->
        <mat-card class="empty-feed-card">
          <mat-card-content>
            <div class="empty-state-content">
              <div class="empty-illustration">
                <mat-icon class="empty-main-icon">forum</mat-icon>
              </div>
              
              <h3 class="empty-title">Welcome to the Community!</h3>
              <p class="empty-description">
                Be the first to share your journey! Post updates, celebrate wins, 
                and connect with others in the community.
              </p>

              @if (userRole() === 'marketer') {
               <button mat-raised-button color="primary" 
                      (click)="createPost.emit()" 
                        class="empty-action-btn">
                  <mat-icon>add_comment</mat-icon>
                  Start the Conversation
                </button>
              } @else {
                <button mat-raised-button color="primary" (click)="viewAll.emit()" class="empty-action-btn">
                  View All Conversation
                </button>
              
              }
             
              <p class="social-hint">
                <mat-icon>group</mat-icon>
                Join {{ activityStats().activeUsers }} others in the community
              </p>
            </div>
          </mat-card-content>
        </mat-card>
      }
    }
  </div>
</div>