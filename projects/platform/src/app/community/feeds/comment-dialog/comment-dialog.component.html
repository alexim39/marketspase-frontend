<div class="comment-dialog">
  <!-- Header -->
  <h2 mat-dialog-title class="dialog-title">
    Comments
    <button mat-icon-button mat-dialog-close class="close-btn" aria-label="Close">
      <mat-icon>close</mat-icon>
    </button>
  </h2>

  <mat-dialog-content class="dialog-content">
    <!-- Loading skeleton -->
    @if (loading()) {
      <div class="loading-spinner">
        <mat-spinner diameter="40"></mat-spinner>
      </div>
    } @else {
      <!-- Comments list -->
      <div class="comments-list" #scrollContainer (scroll)="onScroll($event)">
        @for (comment of comments(); track trackByCommentId($index, comment)) {
          <div class="comment-item">
            <!-- Comment header -->
            <div class="comment-header">
              <div class="user-info">
                <img [src]="comment.user.avatar || 'img/avatar.png'" [alt]="comment.user.displayName" class="avatar">
                <div class="user-details">
                  <span class="user-name">{{ comment.user.displayName }}</span>
                  <span class="comment-time">{{ formatTime(comment.createdAt) }}</span>
                </div>
              </div>
              <button class="like-btn" [class.active]="comment.isLiked" (click)="toggleLike(comment, false)">
                <mat-icon>{{ comment.isLiked ? 'favorite' : 'favorite_border' }}</mat-icon>
                <span>{{ comment.likeCount }}</span>
              </button>
            </div>

            <!-- Comment content -->
            <p class="comment-content">{{ comment.content }}</p>

            <!-- Reply button -->
            <div class="comment-actions">
              <button class="reply-btn" (click)="setReplyTo(comment)">
                <mat-icon>reply</mat-icon> Reply
              </button>
            </div>

            <!-- Replies (nested) -->
            @if (comment.replies && comment.replies.length > 0) {
              <div class="replies-list">
                @for (reply of comment.replies; track reply._id) {
                  <div class="reply-item">
                    <div class="reply-header">
                      <div class="user-info">
                        <img [src]="reply.user.avatar || 'img/avatar.png'" [alt]="reply.user.displayName" class="avatar small">
                        <span class="user-name">{{ reply.user.displayName }}</span>
                        <span class="reply-time">{{ formatTime(reply.createdAt) }}</span>
                      </div>
                      <button class="like-btn small" [class.active]="reply.isLiked" (click)="toggleLike(reply, true, comment)">
                        <mat-icon>{{ reply.isLiked ? 'favorite' : 'favorite_border' }}</mat-icon>
                        <span>{{ reply.likeCount }}</span>
                      </button>
                    </div>
                    <p class="reply-content">{{ reply.content }}</p>
                  </div>
                }
              </div>
            }

            <!-- Inline reply input -->
            @if (replyingTo() === comment) {
              <div class="reply-input">
                <mat-form-field appearance="outline" class="full-width">
                  <textarea matInput [(ngModel)]="replyText" rows="2" placeholder="Write a reply..."></textarea>
                </mat-form-field>
                <div class="reply-actions">
                  <button mat-button (click)="cancelReply()">Cancel</button>
                  <button mat-raised-button color="primary" [disabled]="!replyText().trim() || submitting()" (click)="submitReply(comment)">
                    @if (submitting()) {
                      <mat-spinner diameter="20"></mat-spinner>
                    } @else {
                      Reply
                    }
                  </button>
                </div>
              </div>
            }
          </div>

          @if (!$last) {
            <mat-divider></mat-divider>
          }
        } @empty {
          <div class="empty-state">
            <div class="empty-icon">
              <mat-icon>chat</mat-icon>
            </div>
            <h3>No comments yet</h3>
            <p>Be the first to share your thoughts!</p>
          </div>
        }

        <!-- Load more indicator -->
        @if (loadingMore()) {
          <div class="load-more-spinner">
            <mat-spinner diameter="30"></mat-spinner>
          </div>
        }

        <!-- End of comments -->
        @if (!hasMore() && comments().length > 0) {
          <div class="end-message">
            <span>You've reached the end</span>
          </div>
        }
      </div>
    }
  </mat-dialog-content>

  <!-- New comment input (sticky at bottom) -->
  <mat-dialog-actions class="dialog-actions">
    <div class="comment-input-wrapper">
      <img [src]="(currentUser()?.avatar) || 'img/avatar.png'" alt="Your avatar" class="current-user-avatar">
      <mat-form-field appearance="outline" class="comment-input">
        <textarea matInput [(ngModel)]="newCommentText" rows="2" placeholder="Add a comment..." (keydown.enter)="$event.preventDefault(); submitComment()"></textarea>
      </mat-form-field>
      <button mat-icon-button color="primary" class="send-btn" [disabled]="!newCommentText().trim() || submitting()" (click)="submitComment()">
        @if (submitting()) {
          <mat-spinner diameter="24"></mat-spinner>
        } @else {
          <mat-icon>send</mat-icon>
        }
      </button>
    </div>
  </mat-dialog-actions>
</div>