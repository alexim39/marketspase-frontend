<div class="admin-container">
    <!-- Header Section -->
    <div class="header-section">
        <h1 class="page-title">Testimonial Management</h1>
        <p class="page-subtitle">Manage and moderate user testimonials</p>
    </div>

    <!-- Filters Card -->
    <div class="card">
        <div class="card-content">
            <div class="filters-container">
                <mat-form-field appearance="outline" class="filter-field search-field">
                    <mat-label>Search Testimonials</mat-label>
                    <input matInput (input)="onSearchChange($event)" placeholder="Search by user, message" #searchInput>
                    <mat-icon matSuffix>search</mat-icon>
                </mat-form-field>

                <mat-form-field appearance="outline" class="filter-field">
                    <mat-label>Status</mat-label>
                    <mat-select (selectionChange)="onStatusFilterChange($event)">
                        <div>
                            <mat-option value="all">All Statuses</mat-option>
                            <mat-option value="pending">Pending</mat-option>
                            <mat-option value="approved">Approved</mat-option>
                            <mat-option value="rejected">Rejected</mat-option>
                        </div>
                    </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline" class="filter-field">
                    <mat-label>Rating</mat-label>
                    <mat-select (selectionChange)="onRatingFilterChange($event)">
                        <div>
                        <mat-option value="all">All Ratings</mat-option>
                        <mat-option value="5">5 Stars</mat-option>
                        <mat-option value="4">4 Stars</mat-option>
                        <mat-option value="3">3 Stars</mat-option>
                        <mat-option value="2">2 Stars</mat-option>
                        <mat-option value="1">1 Star</mat-option>
                        </div>
                    </mat-select>
                </mat-form-field>

                <button mat-raised-button color="primary" (click)="applyFilters()">
                    <mat-icon>filter_list</mat-icon>
                    Apply Filters
                </button>
            </div>
        </div>
    </div>

    <!-- Testimonials Table -->
    <div class="card">
        <div class="card-content">
            <div class="table-container">
                <!-- Loading State -->
                 @if (isLoading()) {
                    <div class="loading-spinner">
                        <mat-spinner diameter="40"></mat-spinner>
                        <p>Loading testimonials...</p>
                    </div>
                 } @else {
                    
                <!-- Table Content -->
                <table mat-table [dataSource]="dataSource" class="testimonials-table">
                    <!-- User Column -->
                    <ng-container matColumnDef="user">
                        <th mat-header-cell *matHeaderCellDef> User </th>
                        <td mat-cell *matCellDef="let testimonial">
                            <div class="user-info">
                                <img [src]="testimonial.user.avatar" alt="User avatar" class="user-avatar">
                                <div class="user-details">
                                    <span class="user-name">{{ testimonial.user.name }}</span>
                                    <span class="user-username">@{{ testimonial.user.username }}</span>
                                </div>
                            </div>
                        </td>
                    </ng-container>

                    <!-- Message Column -->
                    <ng-container matColumnDef="message">
                        <th mat-header-cell *matHeaderCellDef> Message </th>
                        <td mat-cell *matCellDef="let testimonial" class="message-cell">
                            <div class="message-preview" [matTooltip]="testimonial.message">
                                {{ testimonial.message }}
                            </div>
                        </td>
                    </ng-container>

                    <!-- Rating Column -->
                    <ng-container matColumnDef="rating">
                        <th mat-header-cell *matHeaderCellDef> Rating </th>
                        <td mat-cell *matCellDef="let testimonial">
                            <div class="rating-stars">
                                @for (star of getStars(testimonial.rating); track star) {
                                    <mat-icon>star</mat-icon>
                                }
                            </div>
                        </td>
                    </ng-container>

                    <!-- Status Column -->
                    <ng-container matColumnDef="status">
                        <th mat-header-cell *matHeaderCellDef> Status </th>
                        <td mat-cell *matCellDef="let testimonial">
                            <mat-chip class="status-chip" [ngClass]="'status-' + testimonial.status">
                                {{ testimonial.status | titlecase }}
                            </mat-chip>
                            <span class="featured-badge" *ngIf="testimonial.isFeatured">Featured</span>
                        </td>
                    </ng-container>

                    <!-- Reactions Column -->
                    <ng-container matColumnDef="reactions">
                        <th mat-header-cell *matHeaderCellDef> Reactions </th>
                        <td mat-cell *matCellDef="let testimonial">
                            <div class="reactions-count">
                                <span class="like-count">
                                    <mat-icon>thumb_up</mat-icon>
                                    {{ testimonial.likes }}
                                </span>
                                <span class="dislike-count">
                                    <mat-icon>thumb_down</mat-icon>
                                    {{ testimonial.dislikes }}
                                </span>
                            </div>
                        </td>
                    </ng-container>

                    <!-- Date Column -->
                    <ng-container matColumnDef="date">
                        <th mat-header-cell *matHeaderCellDef> Date </th>
                        <td mat-cell *matCellDef="let testimonial">
                            {{ testimonial.createdAt | date:'mediumDate' }}
                        </td>
                    </ng-container>

                    <!-- Actions Column -->
                    <ng-container matColumnDef="actions">
                        <th mat-header-cell *matHeaderCellDef> Actions </th>
                        <td mat-cell *matCellDef="let testimonial">
                            <div class="action-buttons">
                                @if (testimonial.status === 'pending') {
                                    <button mat-icon-button class="action-button" 
                                        title="Approve testimonial"
                                        (click)="approveTestimonial(testimonial)"
                                    >
                                    <mat-icon color="primary">check_circle</mat-icon>
                                </button>
                                }
                                
                                @if (testimonial.status === 'pending') {
                                    <button mat-icon-button class="action-button" 
                                        title="Reject testimonial"
                                        (click)="rejectTestimonial(testimonial)"
                                    >
                                        <mat-icon color="warn">cancel</mat-icon>
                                    </button>
                                }
                                

                                <button mat-icon-button class="action-button" 
                                        title="Toggle featured status"
                                        (click)="toggleFeatured(testimonial)">
                                    <mat-icon [color]="testimonial.isFeatured ? 'accent' : ''">star</mat-icon>
                                </button>

                                <button mat-icon-button class="action-button" 
                                        title="View details"
                                        (click)="viewDetails(testimonial)">
                                    <mat-icon>visibility</mat-icon>
                                </button>

                                <button mat-icon-button class="action-button" 
                                        title="Delete testimonial"
                                        (click)="deleteTestimonial(testimonial)">
                                    <mat-icon color="warn">delete</mat-icon>
                                </button>
                            </div>
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

                    <!-- Empty State -->
                    <tr class="mat-row" *matNoDataRow>
                        <td class="mat-cell no-data" [attr.colspan]="displayedColumns.length">
                            No testimonials found matching your criteria
                        </td>
                    </tr>
                </table>
                 }
                
            </div>

            <!-- Pagination -->
             @if (!isLoading() && totalTestimonials() > 0) {
                <mat-paginator [length]="totalTestimonials()"
                    [pageSize]="pageSize()"
                    [pageIndex]="pageIndex()"
                    [pageSizeOptions]="[10, 25, 50, 100]"
                    (page)="onPageChange($event)"
                    aria-label="Select page"
                >
                </mat-paginator>
             }

        </div>
    </div>
</div>