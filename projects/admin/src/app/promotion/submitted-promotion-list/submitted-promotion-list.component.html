<div class="admin-promotions-container">
  <!-- Header Section -->
  <div class="header-section">
    <h1 class="page-title">Submitted Promotion Management</h1>
    <p class="page-subtitle">Manage and review submitted promotions</p>
    
    <!-- Stats Overview -->
    <div class="stats-overview">
      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-content">
            <mat-icon class="stat-icon submitted">send</mat-icon>
            <div class="stat-details">
              <span class="stat-value">{{ totalPromotions() }}</span>
              <span class="stat-label">Submitted Promotions</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
      
      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-content">
            <mat-icon class="stat-icon">assignment</mat-icon>
            <div class="stat-details">
              <span class="stat-value">{{ totalPromotions() }}</span>
              <span class="stat-label">Total for Review</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Filters Card -->
  <mat-card class="filters-card">
    <mat-card-content>
      <div class="filters-container">
        <mat-form-field appearance="outline" class="filter-field search-field">
          <mat-label>Search Promotions</mat-label>
          <input matInput 
                 [formControl]="filtersForm.controls.search"
                 placeholder="Search by promoter, campaign, UPI">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>
        
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Campaign</mat-label>
          <mat-select [formControl]="filtersForm.controls.campaign" multiple>
            @for (campaign of campaigns(); track campaign._id) {
              <mat-option [value]="campaign._id">{{ campaign.title }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Date Range</mat-label>
          <mat-date-range-input [rangePicker]="picker">
            <input matStartDate 
                   placeholder="Start date" 
                   [formControl]="filtersForm.controls.startDate">
            <input matEndDate 
                   placeholder="End date" 
                   [formControl]="filtersForm.controls.endDate">
          </mat-date-range-input>
          <mat-hint>MM/DD/YYYY – MM/DD/YYYY</mat-hint>
          <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-date-range-picker #picker></mat-date-range-picker>
        </mat-form-field>
        
        <button mat-button 
                (click)="clearFilters()" 
                class="clear-filters-btn"
                [disabled]="!filtersForm.dirty">
          <mat-icon>clear</mat-icon>
          Clear Filters
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Promotions Table -->
  <mat-card class="table-card">
    <mat-card-content>
      <div class="table-container">
        @if (isLoading()) {
          <div class="loading-spinner">
            <mat-spinner diameter="40"></mat-spinner>
            <p>Loading promotions...</p>
          </div>
        } @else {
          <table mat-table 
                 [dataSource]="dataSource" 
                 matSort 
                 class="promotions-table">
            
            <!-- UPI Column -->
            <ng-container matColumnDef="upi">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> UPI </th>
              <td mat-cell *matCellDef="let promotion">
                <div class="upi-info">
                  <span class="upi-code">{{ promotion.upi }}</span>
                  <span class="created-date">
                    Created: {{ promotion.createdAt | date:'shortDate' }}
                  </span>
                </div>
              </td>
            </ng-container>

            <!-- Campaign Column -->
            <ng-container matColumnDef="campaign">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> Campaign </th>
              <td mat-cell *matCellDef="let promotion">
                <div class="campaign-info">
                  <span class="campaign-title">
                    {{ getCampaign(promotion.campaign).title }}
                  </span>
                  <span class="campaign-category">
                    {{ getCampaign(promotion.campaign).category }}
                  </span>
                </div>
              </td>
            </ng-container>

            <!-- Promoter Column -->
            <ng-container matColumnDef="promoter">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> Promoter </th>
              <td mat-cell *matCellDef="let promotion">
                <div class="promoter-info">
                  <span class="promoter-name">
                    {{ getPromoter(promotion.promoter).displayName }}
                  </span>
                  <span class="promoter-email">
                    {{ getPromoter(promotion.promoter).email }}
                  </span>
                </div>
              </td>
            </ng-container>

            <!-- Proof Column -->
            <ng-container matColumnDef="proof">
              <th mat-header-cell *matHeaderCellDef> Proof </th>
              <td mat-cell *matCellDef="let promotion">
                <div class="proof-info">
                  @if (promotion.proofMedia.length > 0) {
                    <button mat-button 
                            color="primary" 
                            (click)="viewProofMedia(promotion)"
                            class="proof-button">
                      <mat-icon>image</mat-icon>
                      View Proof ({{ promotion.proofMedia.length }})
                    </button>
                    @if (promotion.proofViews) {
                      <span class="proof-views">Views: {{ promotion.proofViews }}</span>
                    }
                  } @else {
                    <span class="no-proof">No proof submitted</span>
                  }
                </div>
              </td>
            </ng-container>

            <!-- Payout Column -->
            <ng-container matColumnDef="payout">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> Payout </th>
              <td mat-cell *matCellDef="let promotion">
                <div class="payout-info">
                  <span class="payout-amount">
                    {{ getPayoutAmount(promotion) | currency:'NGN':'₦' }}
                  </span>
                </div>
              </td>
            </ng-container>

            <!-- Timeline Column -->
            <ng-container matColumnDef="timeline">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> Timeline </th>
              <td mat-cell *matCellDef="let promotion">
                <div class="timeline-info">
                  @if (promotion.submittedAt) {
                    <span class="submitted-date">
                      Submitted: {{ promotion.submittedAt | date:'shortDate' }}
                    </span>
                  }
                </div>
              </td>
            </ng-container>

            <!-- Status Column -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> Status </th>
              <td mat-cell *matCellDef="let promotion">
                <mat-chip class="status-chip submitted">
                  Submitted
                </mat-chip>
                @if (isOverdue(promotion)) {
                  <mat-icon class="overdue-icon" 
                            matTooltip="Overdue for validation">
                    warning
                  </mat-icon>
                }
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef> Actions </th>
              <td mat-cell *matCellDef="let promotion">
                <div class="action-buttons">
                  <button mat-icon-button 
                          matTooltip="View Proof"
                          (click)="viewProofMedia(promotion)">
                    <mat-icon>visibility</mat-icon>
                  </button>

                  <button mat-icon-button 
                          [matMenuTriggerFor]="menu" 
                          matTooltip="More Actions">
                    <mat-icon>more_vert</mat-icon>
                  </button>
                  
                  <mat-menu #menu="matMenu">
                    <button mat-menu-item (click)="validatePromotion(promotion)">
                      <mat-icon>check_circle</mat-icon>
                      <span>Validate</span>
                    </button>
                    <button mat-menu-item (click)="openRejectDialog(promotion)">
                      <mat-icon>cancel</mat-icon>
                      <span>Reject</span>
                    </button>
                    @if (promotion.proofMedia.length > 0) {
                      <button mat-menu-item (click)="viewProofMedia(promotion)">
                        <mat-icon>image</mat-icon>
                        <span>View Proof Media</span>
                      </button>
                    }
                  </mat-menu>
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

            <!-- No Data Row -->
            <tr class="mat-row" *matNoDataRow>
              <td class="mat-cell no-data" [attr.colspan]="displayedColumns.length">
                No submitted promotions found matching your criteria
              </td>
            </tr>
          </table>
        }
      </div>

      <mat-paginator [pageSizeOptions]="[10, 25, 50, 100]" 
                     showFirstLastButtons 
                     aria-label="Select page of promotions">
      </mat-paginator>
    </mat-card-content>
  </mat-card>
</div>

<!-- Proof Media Dialog -->
<ng-template #proofMediaDialog>
  @if (selectedPromotion(); as promotion) {
    <div class="proof-media-dialog">
      <h2 mat-dialog-title>Proof Media</h2>
      <mat-dialog-content>
        <div class="proof-media-grid">
          @for (media of promotion.proofMedia; track media; let i = $index) {
            <div class="proof-media-item">
              <img [src]="media" 
                   [alt]="'Proof media ' + (i + 1)" 
                   class="proof-image"
                   loading="lazy">
              <div class="proof-media-info">
                <span>Proof {{ i + 1 }}</span>
              </div>
            </div>
          }
        </div>
        
        <div class="promotion-info">
          <h4>Promotion Details</h4>
          <p><strong>UPI:</strong> {{ promotion.upi }}</p>
          <p><strong>Views:</strong> {{ promotion.proofViews || 'Not specified' }}</p>
          <p><strong>Submitted:</strong> {{ promotion.submittedAt | date:'medium' }}</p>
          <p><strong>Campaign:</strong> {{ getCampaign(promotion.campaign).title }}</p>
          <p><strong>Promoter:</strong> {{ getPromoter(promotion.promoter).displayName }} 
            ({{ getPromoter(promotion.promoter).email }})</p>
          
          <div class="dialog-actions">
            <button mat-raised-button 
                    color="primary" 
                    (click)="validatePromotion(promotion)">
              <mat-icon>check_circle</mat-icon>
              Validate Promotion
            </button>
            
            <button mat-flat-button 
                    color="warn" 
                    (click)="openRejectDialog(promotion)">
              <mat-icon>cancel</mat-icon>
              Reject Promotion
            </button>
          </div>
        </div>
      </mat-dialog-content>
      <mat-dialog-actions align="end">
        <button mat-button mat-dialog-close>Close</button>
      </mat-dialog-actions>
    </div>
  }
</ng-template>

<!-- Reject Promotion Dialog -->
<ng-template #rejectDialog>
  @if (selectedPromotion()) {
    <div class="reject-dialog">
      <h2 mat-dialog-title>Reject Promotion</h2>
      <mat-dialog-content>
        <p>Please provide a reason for rejecting this promotion:</p>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Rejection Reason</mat-label>
          <textarea matInput 
                    [ngModel]="rejectionReason()"
                    (ngModelChange)="rejectionReason.set($event)"
                    placeholder="Enter the reason for rejection..."
                    rows="4"
                    required></textarea>
        </mat-form-field>
      </mat-dialog-content>
      <mat-dialog-actions align="end">
        <button mat-button mat-dialog-close>Cancel</button>
        <button mat-raised-button 
                color="warn" 
                (click)="rejectPromotion()"
                [disabled]="!rejectionReason().trim()">
          Reject Promotion
        </button>
      </mat-dialog-actions>
    </div>
  }
</ng-template>