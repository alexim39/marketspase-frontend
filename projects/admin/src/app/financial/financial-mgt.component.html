<!-- financial-management.component.html -->
<main class="financial-content">
  <!-- Stats Overview with real data -->
  <section class="stats-section">
    <div class="stats-grid">
      <div class="stat-card primary">
        <div class="stat-icon">
          <mat-icon>account_balance</mat-icon>
        </div>
        <div class="stat-content">
          <div class="stat-label">Total Platform Revenue</div>
          <div class="stat-value">₦{{ financialStats().totalRevenue.toLocaleString() }}</div>
          <div class="stat-change positive">
            <mat-icon>trending_up</mat-icon>
            +{{ ((financialStats().successfulWithdrawals || 0) / (financialStats().totalWithdrawals || 1) * 100).toFixed(1) }}% success rate
          </div>
        </div>
      </div>

      <div class="stat-card success">
        <div class="stat-icon">
          <mat-icon>check_circle</mat-icon>
        </div>
        <div class="stat-content">
          <div class="stat-label">Completed Withdrawals</div>
          <div class="stat-value">₦{{ totalSuccessfulAmount().toLocaleString() }}</div>
          <div class="stat-change positive">
            <mat-icon>check</mat-icon>
            {{ financialStats().successfulWithdrawals || 0 }} transactions
          </div>
        </div>
      </div>

      <div class="stat-card warning">
        <div class="stat-icon">
          <mat-icon>pending</mat-icon>
        </div>
        <div class="stat-content">
          <div class="stat-label">Processing</div>
          <div class="stat-value">₦{{ totalProcessingAmount().toLocaleString() }}</div>
          <div class="stat-change">
            <mat-icon>schedule</mat-icon>
            {{ financialStats().processingWithdrawals || 0 }} pending
          </div>
        </div>
      </div>

      <div class="stat-card danger">
        <div class="stat-icon">
          <mat-icon>error</mat-icon>
        </div>
        <div class="stat-content">
          <div class="stat-label">Failed</div>
          <div class="stat-value">₦{{ totalFailedAmount().toLocaleString() }}</div>
          <div class="stat-change negative">
            <mat-icon>warning</mat-icon>
            {{ financialStats().failedWithdrawals || 0 }} failed
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Financial Management Tabs -->
  <section class="management-section">
    <mat-tab-group (selectedTabChange)="onTabChange($event)">
      <!-- Withdrawal Requests Tab -->
      <mat-tab label="Withdrawals">
        <div class="tab-content">
          <!-- Filters and Actions -->
          <div class="section-header">
            <div class="filters-container">
              <div class="search-box">
                <mat-icon>search</mat-icon>
                <input 
                  type="text" 
                  placeholder="Search by name, email, bank, or reference..." 
                  (input)="onSearchChange($event)"
                  [value]="searchTerm()"
                  class="search-input">
              </div>
              
              <div class="filter-buttons">
                <button 
                  class="filter-btn" 
                  [class.active]="statusFilter() === 'all'"
                  (click)="onStatusFilterChange('all')">
                  All 
                </button>
                <button 
                  class="filter-btn warning" 
                  [class.active]="statusFilter() === 'pending_approval'"
                  (click)="onStatusFilterChange('pending_approval')">
                  Pending Approval
                </button>
                <button 
                  class="filter-btn info" 
                  [class.active]="statusFilter() === 'processing'"
                  (click)="onStatusFilterChange('processing')">
                  Processing
                </button>
                <button 
                  class="filter-btn success" 
                  [class.active]="statusFilter() === 'successful'"
                  (click)="onStatusFilterChange('successful')">
                  Completed
                </button>
                <button 
                  class="filter-btn danger" 
                  [class.active]="statusFilter() === 'failed'"
                  (click)="onStatusFilterChange('failed')">
                  Failed
                </button>
              </div>
            </div>

            <div class="action-buttons">
              <button class="btn btn-secondary" (click)="clearFilters()" matTooltip="Clear all filters">
                <mat-icon>clear</mat-icon>
              </button>
              <button class="btn btn-primary" (click)="exportWithdrawals()" matTooltip="Export to CSV">
                <mat-icon>download</mat-icon>
                Export
              </button>
            </div>
          </div>

          <!-- Withdrawal Requests Table -->
          <div class="table-container">
            @if (isWithdrawalsLoading()) {
              <div class="loading-state">
                <mat-spinner diameter="40"/>
                <p>Loading withdrawal requests...</p>
              </div>
            } @else {
              <table mat-table [dataSource]="paginatedWithdrawals()" class="financial-table">
                <!-- User Column -->
                <ng-container matColumnDef="user">
                  <th mat-header-cell *matHeaderCellDef>User</th>
                  <td mat-cell *matCellDef="let request">
                    <div class="user-info">
                      <div class="user-name">{{ request.userName }}</div>
                      <div class="user-email">{{ request.userEmail }}</div>
                    </div>
                  </td>
                </ng-container>

                <!-- Amount Column -->
                <ng-container matColumnDef="amount">
                  <th mat-header-cell *matHeaderCellDef>Amount</th>
                  <td mat-cell *matCellDef="let request">
                    <div class="amount-cell">
                      <div class="amount" [class.text-danger]="request.status === 'failed'">
                        ₦{{ request.amount.toLocaleString() }}
                      </div>
                      <div class="date">{{ request.createdAt | date:'MMM d, y' }}</div>
                    </div>
                  </td>
                </ng-container>

                <!-- Payable Amount Column -->
                <ng-container matColumnDef="amountPayable">
                  <th mat-header-cell *matHeaderCellDef>Net Amount</th>
                  <td mat-cell *matCellDef="let request">
                    <div class="amount-cell">
                      @if (request.amountPayable) {
                        <div class="amount success-text">
                          ₦{{ request.amountPayable.toLocaleString() }}
                        </div>
                        <div class="date">Fee: ₦{{ (request.amount - request.amountPayable).toLocaleString() }}</div>
                      } @else {
                        <div class="amount">—</div>
                      }
                    </div>
                  </td>
                </ng-container>

                <!-- Bank Details Column -->
                <ng-container matColumnDef="bankDetails">
                  <th mat-header-cell *matHeaderCellDef>Bank Details</th>
                  <td mat-cell *matCellDef="let request">
                    <div class="bank-info">
                      <div class="bank-name">{{ request.bankName }}</div>
                      <div class="account-number">{{ request.accountNumber }}</div>
                      <div class="account-name">{{ request.accountName }}</div>
                    </div>
                  </td>
                </ng-container>

                <!-- Reference Column -->
                <ng-container matColumnDef="reference">
                  <th mat-header-cell *matHeaderCellDef>Reference</th>
                  <td mat-cell *matCellDef="let request">
                    <div class="reference-info">
                      <div class="ref" matTooltip="{{ request.reference }}">
                        {{ request.reference | slice:0:12 }}...
                      </div>
                      @if (request.providerReference) {
                        <div class="provider-ref" matTooltip="Paystack ref: {{ request.providerReference }}">
                          <mat-icon class="small-icon">paid</mat-icon>
                        </div>
                      }
                    </div>
                  </td>
                </ng-container>

                <!-- Status Column -->
                <ng-container matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef>Status</th>
                  <td mat-cell *matCellDef="let request">
                    <div class="status-container">
                      <mat-icon class="status-icon" [class]="getStatusClass(request.status)">
                        {{ getStatusIcon(request.status) }}
                      </mat-icon>
                      <span class="status-badge" [class]="getStatusClass(request.status)">
                        {{ getStatusLabel(request.status) }}
                      </span>
                    </div>
                    @if (request.failureReason) {
                      <div class="failure-reason" matTooltip="{{ request.failureReason }}">
                        <mat-icon class="error-icon">error_outline</mat-icon>
                      </div>
                    }
                  </td>
                </ng-container>

                <!-- Date Column -->
                <ng-container matColumnDef="date">
                  <th mat-header-cell *matHeaderCellDef>Date</th>
                  <td mat-cell *matCellDef="let request">
                    <div class="date-cell">
                      <div class="created-date">{{ request.createdAt | date:'MMM d, y' }}</div>
                      <div class="time">{{ request.createdAt | date:'shortTime' }}</div>
                      @if (request.processedAt) {
                        <div class="processed-date" matTooltip="Processed: {{ request.processedAt | date:'medium' }}">
                          <mat-icon class="small-icon">schedule</mat-icon>
                        </div>
                      }
                    </div>
                  </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef>Actions</th>
                  <td mat-cell *matCellDef="let request">
                    <div class="action-buttons">
                      <button 
                        class="btn-icon" 
                        (click)="viewWithdrawalDetails(request)"
                        matTooltip="View Details">
                        <mat-icon>visibility</mat-icon>
                      </button>

                      @if (request.status === 'pending_approval') {
                        <button 
                          class="btn-icon success" 
                          (click)="approveWithdrawal(request)"
                          matTooltip="Approve Withdrawal">
                          <mat-icon>check_circle</mat-icon>
                        </button>
                        <button 
                          class="btn-icon danger" 
                          (click)="rejectWithdrawal(request)"
                          matTooltip="Reject Withdrawal">
                          <mat-icon>cancel</mat-icon>
                        </button>
                      }

                      @if (request.status === 'failed') {
                        <button 
                          class="btn-icon warning" 
                          (click)="retryWithdrawal(request)"
                          matTooltip="Retry Failed Withdrawal">
                          <mat-icon>refresh</mat-icon>
                        </button>
                      }
                    </div>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="withdrawalColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: withdrawalColumns;"></tr>
              </table>

              <!-- Empty State -->
              @if (paginatedWithdrawals().length === 0) {
                <div class="empty-state">
                  <mat-icon>payments</mat-icon>
                  <h3>No withdrawal requests found</h3>
                  <p>There are no withdrawal requests matching your current filters.</p>
                  @if (statusFilter() !== 'all' || searchTerm()) {
                    <button class="btn btn-secondary" (click)="clearFilters()">
                      Clear Filters
                    </button>
                  }
                </div>
              }

              <!-- Pagination -->
              @if (totalItems() > pageSize()) {
                <mat-paginator
                  [length]="totalItems()"
                  [pageSize]="pageSize()"
                  [pageIndex]="currentPage()"
                  [pageSizeOptions]="[50, 100, 200, 500]"
                  (page)="onPageChange($event)"
                  aria-label="Select page"
                  showFirstLastButtons>
                </mat-paginator>
              }
            }
          </div>
        </div>
      </mat-tab>

      <!-- Transaction History Tab -->
      <mat-tab label="Deposits">
        <div class="tab-content">
          <div class="section-header">
            <h3>All Transactions</h3>
            <button class="btn btn-secondary" (click)="exportTransactions()">
              <mat-icon>download</mat-icon>
              Export
            </button>
          </div>

          <div class="table-container">
            @if (isTransactionsLoading()) {
              <div class="loading-state">
                <mat-spinner diameter="40"/>
                <p>Loading transactions...</p>
              </div>
            } @else {
              <!-- Transaction table would go here -->
              <p>Transaction history table implementation...</p>
            }
          </div>
        </div>
      </mat-tab>
    </mat-tab-group>
  </section>
</main>